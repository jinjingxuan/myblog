# 北大肖臻老师《区块链技术与应用》公开课学习 4
* 学习地址：[https://www.bilibili.com/video/BV1Vt411X7JF](https://www.bilibili.com/video/BV1Vt411X7JF)

## BTC 分叉

### state fork
如果两个节点差不多同时挖到一个区块，这两个区块都是挂在当前的区块上的，不同节点先收到的区块不同，就会各自沿着先收到的区块往下扩展，这种时候就会出现临时性的分叉，称为`state fork`，即由于对区块链当前的状态有意见分歧而产生的分叉。

分叉攻击（forking attack）也属于`state fork`，只不过这种意见分歧是人为造成的，这种情况也称为 `deliberate fork`。

### protocol fork
要修改比特币协议需要软件升级，在去中心化的系统中，没办法要求所有的结点都升级软件

假设大部分节点升级了软件，少部分节点没有升级（可能是没来得及升级，也可能是不同意协议的修改），这种分叉称为protocol fork，即对比特币协议产生了分歧，使用不同版本的协议而产生的分叉。

在 `protocol fork` 中，根据对协议修改的内容的不同，又可以分为硬分叉和软分叉。

#### 硬分叉
如果区块链软件的共识规则被改变，并且这种规则改变无法向前兼容，旧节点无法认可新节点产生的区块，即为硬分叉。

1. **比特币分叉**

一些人开始觉得比特币的区块容量太小，总出现拥堵，于是这些人要求对比特币的区块大小进行升级扩容。有人支持就有人反对，这种对比特币发展的分歧导致了比特币首次硬分叉，旧链上的币仍然是比特币 `BTC`(区块容量达到了8M)，新链上的币是 `BCH`（Bitcoin Cash，比特币现金。区块容量达到了8M）。

`BCH` 和 `BTC` 最大的区别只是在于区块容量的参数不同，两者分叉前的交易都是一样的，只是交易的币种不一样。可以理解为 `BCH` 那条链把分叉前的区块里的交易按照原来的方式重新运行了一遍，只是把币种由原来的 `BTC` 换成了 `BCH`。
`
2. **以太坊分叉**

`The DAO` 项目是区块链物联网公司 `Slock.it` 发起的一个众筹项目，于2016年5月正式发布，截止到当年6月，`The DAO` 项目募集资金超过 `1.6` 亿美元。没过多久，`The DAO` 项目就被黑客盯上了，因为智能合约上的巨大漏洞，导致 `The DAO` 项目被转移了市值五千万美元的以太币。

为了挽回众多投资者的资产并停止恐慌，以太坊创始人V神（Vitalik Buterin）最后提出硬分叉的设想，并最终通过社区的多数投票表决在以太坊第 `1920000` 区块完成了硬分叉，回滚了包括被黑客占有的所有以太币。即使以太坊硬分叉成了两条链，依然有部分信仰着区块链不可篡改特性的人留在以太经典这条原链上。

目前的以太坊 `ETH` 就是硬分叉之后的，原来的链是 `ETC`。分叉之初，由于两个链分叉造成了互相影响，产生了很多麻烦。比如：在 `ETH` 链上有一笔转账 `B->C`，有人便在 `ETC` 链上回放，将 `ETC` 链上的货币页转给了 `C`(C收到两笔钱)。后来，对两条链各添加了一个 `chainID`，将两个链区分开，才使得这两条链真正分开。

#### 软分叉
如果区块链的共识规则改变后，这种改变是向前兼容的，旧节点可以兼容新节点产生的区块，即为软分叉。

实际上，软分叉通常刚开始并不会产生两条区块链，因为新规则下产生的块会被旧节点接受，旧节点只是无法识别新规则的真实意义。所以新旧节点仍然处于同一条区块链上，对整个系统的影响也就较小。

1. **coinbase 域**

铸币交易中 `CoinBase` 域。在 `CoinBase` 域中写入任何内容都可以，挖矿本质是调整 `block header` 中的 `nonce` ，但其本身只有 `4` 个字节，搜索空间太小。所以实际使用中，将 `CoinBase` 域前 `8` 个自己作为另一个 `extra nonce`，此时搜索空间从原本`2^32` 增长到 `2^96`，对于目前挖矿难度来说已经足够。但 `CoinBase` 中并不是只有8个字节，还剩下很多空间。

`Coinbase` 交易的输入中有一个字段 `coinbase data` 内容可以任意定制。`BIP-34` 就是要求在 `coinbase data` 中必须包含块高度（Block Height）信息且将块版本（Block version）从 `1` 修改为 `2`。

显然在旧规则下，节点并不关心 `coinbase data` 是什么内容，完全可以兼容包含块高度信息的区块，所以不会就此产生分叉。

`BIP-34` 的升级过程如下：
* 刚开始矿工将块版本号变为`2`以表示准备好进行升级，此时并不要求 `coinbase data` 必须包含块高度信息。
* 当最近 `1000` 个区块中超过 `75%` 的版本号为 `2`时，整个系统开始强制要求版本号为 `2` 的区块 `coinbase data` 中必须包含块高度信息。但版本号为 `1` 的区块仍然被所有节点接受。
* 当最近 `1000` 个区块中超过 `95%` 的版本号为 `2` 时，版本号为 `1` 的区块开始被认为无效，节点会拒绝版本号为 `1` 的区块，于是会逼迫最后一小部分节点进行升级。（否则完成挖矿获得的奖励将失去价值）。

2. **P2SH：Pay to Script Hash**

`P2SH（Pay to Script Hash）` 形式的交易脚本，最开始的比特币系统中是没有的，是后来通过软分叉的方式加进去的。`P2SH` 会把 `redeem script` 的内容在第二阶段执行，这个过程旧节点认为是合法的，因为旧节点只会验证第一阶段。

软分叉提供了一种逐步升级比特币的方式，除了 `BIP-34`，还有 `BIP-65`、`BIP-66`、`BIP-9` 等特性进行了软分叉升级。

> soft fork: 只要系统中拥有半数以上算力节点更新软件，系统就不会产生永久性分叉。
> hard fork: 必须系统中所有节点更新软件，系统才不会产生永久性分叉。

## BTC 问答

1. 转账交易时候，如果接收者不在线(没有连在比特币网络上)怎么办？
> 转账交易只需要在区块链上记录，将某账户比特币转到另一账户，而接收方是否在线并无影响。
2. 假设某全节点收到某个转账交易，会不会有可能转账交易中收款人地址该全节点从未听过。
> 可能，因为比特币账户只需要本地产生即可。只有该账户第一次收到钱时，其他节点才能知道该节点的存在。
3. 如果账户私钥丢失怎么办？
> 没有办法。因为比特币是去中心化货币，没有第三方中心机构可以重置密码，所以账户上的钱也就变成了死钱。
> 通过加密货币交易所(中心化机构)，一般需要提供身份证明，如果忘记私钥可以找交易所申请追回私钥。但目前这类货币的交易所，尚且处于缺少监管的状态，并不一定具有可信力。而且，其本身仅起到“中介”作用，与该提问的回答“私钥丢失无法追回里面的比特币”并不冲突。
> 在历史上，有很多次交易所被黑客攻击偷走大量加密货币的事情，其中最著名的为 `Mt. GOX`（中文译为：门头沟）事件。该交易所曾经为全球最大比特币交易所，交易量占到全球比特币交易量的 `70%` 左右，设于日本。后来由于被攻击丢失大量比特币，导致交易所破产，其 `CEO` 被判刑入狱。
4. 私钥泄露怎么办？
> 尽快将剩余BTC转到其他安全账户上，没有第三方中心机构重置密码或冻结账户，只能自己对自己负责。BTC系统中账户便是公私钥对，密码就是私钥，无法更改。
5. 转账写错地址怎么办？
> 没有办法，只能自认倒霉，无法取消已经发布的交易。如果转入不存在地址，则该部分比特币便成为了死钱。当然，比特币系统中 `UTXO` 会永久保存该交易，记录该并不存在的地址。因此对全节点来说这是不友好的。
6. 之前在 `BTC` 脚本中介绍了 `OP_RETURN` 指令，我们提到，这种方法为普通用户提供了一个向比特币网络中写入想要一直保存的内容。但`OP_RETURN` 执行结果是无条件返回错误，而交易返回错误，区块又怎么会包含它？区块链又如何会接收这个区块？
> 实际上要想清楚，`OP_RETURN` 是写在哪里的。`OP_RETURN` 实际写在当前交易的输出脚本中，而验证交易合法性时，使用的当前交易的输入脚本和前一个交易(币来源的交易)的输出脚本进行验证。也就是说，验证当前交易合法性时，并不会执行该语句。只有在有人想花这笔钱时候，才会执行该语句。
7. BTC系统挖矿，会不会有矿工“偷”答案？例如：某个矿工发现其他矿工发布了nonce，收到后验证该区块合法，将该nonce作为自己找到的nonce发布出去。
> 实际上这是不可能的。发布的区块中包含铸币交易，其收款人地址为挖到矿的矿工地址，如果要偷答案，需要修改该收款地址，而地址改变，铸币交易内容也发生改变，从而引发 `Merkle Tree` 根哈希值改变。从而导致原本的 `nonce` 作废。
8. 交易费是交易者为了自己交易可以上链而给出的“小费”，那么如何得知哪个矿工可以挖到矿？
> 事先无需知道谁会挖到矿，交易中总输入和总输出差额就是交易费。哪个矿工挖到矿，在打包交易时，可以将这些交易费收集起来作为自己获得的交易费。