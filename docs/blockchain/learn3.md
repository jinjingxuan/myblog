# 北大肖臻老师《区块链技术与应用》公开课学习 3
* 学习地址：[https://www.bilibili.com/video/BV1Vt411X7JF](https://www.bilibili.com/video/BV1Vt411X7JF)

## BTC 中的节点

### 全节点
* 一直在线
* 在本地硬盘上维护完整区块链信息
* 在内存中维护UTXO集合，以便于快速检验交易合法性
* 监听比特币网络中交易内容，验证每个交易合法性
* 决定哪些交易会打包到区块中
* 监听其他矿工挖出的区块，验证其合法性
  * 区块中的每个交易都要合法
  * 发布的区块是不是符合难度要求、难度目标阈值的设置是否正确、每两周调整的挖矿难度
  * 区块是在延伸最长合法链
* 挖矿
  * 决定沿着哪条链挖下去
  * 当出现等长分叉，选择哪一个分叉

### 轻节点
* 不是一直在线
* 不保存整个区块链，只需要保存每隔区块块头
* 不保存全部交易，只保存和自己有关的交易
* 无法验证大多数交易合法性，只能检验和自己相关的交易合法性
* 无法检测网上发布的区块正确性
* 可以验证挖矿难度
* 只能检测哪个是最长链，不知道哪个是最长合法链

在比特币网络中，大多数节点都是轻节点。如果只是想进行转账操作，不需要挖矿，就无需运行一个全节点。在挖矿过程中，如果监听到别人已经挖出区块延申了最长合法链，此时应该立刻放弃当前区块，在本地重新组装一个指向最后这个新合法区块的候选区块，重新开始挖矿。

这样是不是有些可惜？之前花费好多资源，全部白挖了。
> 实际上并不可惜。之前文章中提及，挖矿本身具有无记忆性，前面无论挖多久，对后续继续挖矿没有影响。
比特币系统如何安全性？
> 一是密码学的保证：别人没有自己的私钥，就无法伪造其合法签名，从而无法将其账户上BTC转走。（前提：系统中大多数算力掌握在好人手中）
> 二是共识机制：保证了恶意交易不被系统承认。

## 挖矿设备演化
目前，挖矿设备逐渐趋于专业化，其经历了三个过程，总体趋势从通用到越来越专用。
普通CPU -> GPU -> ASIC芯片（挖矿专用矿机）
> 实际上，挖矿本身就是计算，对于普通计算机来说，挖矿过程中大多数内存、硬盘、CPU中大多数部件（用到指令较少）等都是闲置的，如果用普通计算机专门用于挖矿是根本不划算的。随着挖矿难度提高，用通用计算机挖矿很快变得无利可图。
> 所以，挖矿设备转入第二代——GPU(主要用于大规模并行计算，如：深度学习)。但是，用GPU挖矿，仍然有一定浪费(GPU为通用并行计算设计，挖矿仍然有很多部件闲置。例如：浮点数运算部件，挖矿过程只使用整数操作，该部分部件根本不会用到)。
GPU价格上涨，仅仅是深度学习火热导致的吗？实际上，很多GPU被用于了挖矿。
> 当然，目前GPU挖矿也已经不划算了（目前一些新开发货币仍然用GPU挖矿）。所以，开始进入第三代设备：ASIC芯片（专门为挖矿设计的芯片），这种芯片专门为挖矿设计，只能用于特定币种的挖矿。
> 但ASIC芯片设计、流片流程很长，假如BTC价格剧烈变化，前期投入很可能会血本无归。所以，ASIC芯片需要提前预订。假如BTC系统中，算力突然很猛烈增加，一般是一个大的厂商生产出新的ASIC矿机。

## 矿池
单个矿工挖矿的收益是很不稳定的，平均出块时间10分钟是对于比特币系统中的所有矿工而言的。一个矿工用一个矿机挖出矿的时间可能要很久，并且除了挖矿之外还要承担全结点的其它责任。

矿池将很多矿工组织起来，一般的架构就是一个矿主（pool manager）全结点去驱动很多矿机，下属矿工只负责计算哈希值，全结点的其它职能只由矿主来承担。有了收益以后再大家一起分配。

![](./imgs/manager.png)

如果矿机来自不同机构，这时候矿工很可能分布在世界各地，只是都加入了这个矿池。矿工和矿主联系，矿主将要计算的哈希值的任务分配给他，矿工计算好后将结果发给矿主，最终得到出块奖励后一起参与分红。

### 矿工利益分配
1. 平均分配，所有人平分出块奖励。
> 大家一起"吃大锅饭"，会导致某些矿工懈怠，不干活（挖矿要费电，需要成本）。反正又不影响最后平均分配。
> 所以，这里也需要进行按劳分配，需要一个工作量证明的方案。如何证明每个矿工所作的工作量呢？
2. 降低挖矿难度
> 假设原本挖矿难度要求，计算所得 `126位` 的哈希值前 `70位` 都必须为0，现在降低要求，只需要前 `60位` 为0，这样挖矿会更容易挖到。当然，这个哈希是不会被区块链所承认的，我们将其称为一个 `share`，或 `almost valid share`。矿工每挖到一个 `share`，将其提交给矿主，矿主对其进行记录，作为矿工工作量的证明。等到某个矿工真正挖到符合要求的的区块后，根据所有矿工提交的 `share` 数量进行分配。因为每个矿工尝试的 `nonce` 越多，挖到矿的可能性越大，所能得到的 `share` 也会越多，所以这种方案作为工作量证明方案是可行的。

### 可能出现的问题
1. 矿工会不会平时正常提交 `share`，但真正挖到区块后不提交给矿主而是自己偷偷发布出去
> 不可能。因为矿主已经组装好了区块，交给矿工计算，区块中铸币交易的收款人地址是矿主。
2. 那么矿工可以可以把铸币交易的收款人改成自己呢？
> 如果自己把铸币交易的地址改成自己的，然后去挖矿，这样提交上去的 `share` 矿主是不认可的，挖出来的矿虽然是自己的，但是整体看来就是自己单干，根本没必要加入矿池。
3. 有没有可能矿工捣乱？平时提交share，等挖到后扔掉区块，不提交？
> 可能是有，如果矿工本身仅仅想捣乱，是可以这么做的。但扔掉区块后，对其本身来说，也没有相应的奖励获得，看似是损人不利己的情况。
> 但是，矿池之间存在竞争关系。有可能为了打击竞争对手，从而起到搞破坏的作用。

### 矿池的数据
![](./imgs/pool.png)

如果存在一个矿池(GHash.IO)算力比例占据全部算力一半以上，当时引起了恐慌(一个矿池就可以发动51攻击)。之后，该矿池主动降低了矿池算力，避免动摇人们对比特币信心。

有可能表面看上去是安全的，但实际实上某个机构如果有超过50%算力，其必然不会将其放入一个矿池中。而是将其分散隐藏，真正需要发动攻击时候再集中起来发动攻击

> 由这些数据可以得知，矿池本身对 BTC 系统带来了较大威胁。某个恶意用户如果想发动攻击，以前需要自己达到 51% 算力，现在自己只需要作为矿主，只需要很少一部分算力就可以了。只要能够吸引到足够多的不明真相的矿工，便可以用较低成本实现攻击。
> 当然，矿主经验管理矿池，也需要收取一定比例(出块奖励、交易费)作为管理费用。如果恶意者想要攻击系统，会将管理费降低甚至赔本吸引足够多矿工加入。这便使得发动攻击变得容易了起来。

### 矿池可以发动哪些攻击
1. 分叉攻击: 对已经经过6次确认的交易分叉，利用51%算力将交易记录回滚。
> 矿工只能计算哈希值，并不知道区块包含哪些交易，区块链状况是什么，所以容易被利用。
> 此外，51%攻击只是一个概率问题，并非达到51%算力就能发动攻击，不能达到就无法发动攻击。此外，矿池本身算力也是在不断变化的。
2. 封锁交易
> 假如攻击者不喜欢某个账户A，不想让A的交易上区块链，在监听到有其他人将A的交易发布到区块链上时，立刻发动分叉攻击，使A所在链无法成为最长合法链。这样，便实现了对A账户的封锁。其他矿工因为害怕，可能也不会将A的交易记录下来。
3. 偷币
> 这个是不可能的，因为其并没有他人账户私钥。如果依仗算力强，强行将没有签名的转账发布到区块链，正常节点不会认为其合法，这样，即使这条链再长，其他人也不会认为其是最长合法链。